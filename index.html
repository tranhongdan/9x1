<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Học Bảng Cửu Chương Vui Nhộn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Baloo 2', cursive;
            overscroll-behavior: none; /* Prevents pull-to-refresh */
        }
        .table-button.active {
            background-color: #4f46e5;
            color: white;
            transform: scale(1.1);
        }
        .feedback-correct { animation: pop 0.3s ease-out; }
        .feedback-wrong { animation: shake 0.5s ease-in-out; }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .number-pad-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .flash-green { animation: flashGreen 1.2s ease; }
        .flash-red { animation: flashRed 0.8s ease; }
        @keyframes flashGreen {
            0%, 100% { background-color: white; }
            50% { background-color: #dcfce7; }
        }
        @keyframes flashRed {
            0%, 100% { background-color: white; }
            25%, 75% { background-color: #fee2e2; }
            50% { background-color: white; }
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        canvas {
            background-color: #f0fdf4;
            border-radius: 8px;
            border: 2px solid #86efac;
        }
        .snake-control-btn {
            transition: all 0.2s ease-in-out;
             touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 min-h-screen flex items-center justify-center p-4">

    <div id="main-container" class="w-full max-w-lg md:max-w-4xl h-full mx-auto bg-white/70 backdrop-blur-sm rounded-2xl shadow-2xl p-4 md:p-6 transition-all duration-300">

        <!-- Home Screen -->
        <div id="home-screen" class="screen active h-full">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-5xl font-extrabold text-indigo-700">Bé Vui Học Toán</h1>
                <p class="text-gray-600 mt-2 text-lg">Chào mừng bé! Hãy chọn một chế độ nhé.</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="go-to-learn" class="w-full text-xl md:text-2xl font-bold bg-blue-500 text-white p-5 md:p-8 rounded-xl shadow-lg hover:bg-blue-600 transition transform hover:scale-105">Học Bài</button>
                <button id="go-to-quiz" class="w-full text-xl md:text-2xl font-bold bg-purple-500 text-white p-5 md:p-8 rounded-xl shadow-lg hover:bg-purple-600 transition transform hover:scale-105">Kiểm Tra</button>
                <button id="go-to-snake" class="w-full text-xl md:text-2xl font-bold bg-green-500 text-white p-5 md:p-8 rounded-xl shadow-lg hover:bg-green-600 transition transform hover:scale-105">Rắn Săn Mồi</button>
            </div>
        </div>

        <!-- Learn Screen -->
        <div id="learn-screen" class="screen h-full">
            <button class="back-btn mb-4 font-bold text-indigo-600 hover:text-indigo-800 self-start">&larr; Quay về Trang chủ</button>
            <h2 class="text-xl md:text-2xl font-bold text-center text-purple-700 mb-4">Chọn Bảng Cửu Chương Để Học</h2>
            <div id="learn-table-selection" class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-9 gap-2 mb-6"></div>
            <div id="table-display-container" class="bg-indigo-50 p-6 rounded-xl shadow-md hidden">
                <h2 class="text-2xl font-bold text-center text-indigo-700 mb-4">Bảng Cửu Chương <span id="table-number-display"></span></h2>
                <div id="table-content" class="text-lg text-gray-800 text-center grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2"></div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen h-full">
            <button class="back-btn mb-4 font-bold text-indigo-600 hover:text-indigo-800 self-start">&larr; Quay về Trang chủ</button>
            <div id="quiz-setup" class="w-full">
                <h2 class="text-xl md:text-2xl font-bold text-center text-purple-700 mb-4">Chọn Bảng Cửu Chương Để Bắt Đầu</h2>
                <div id="quiz-table-selection" class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-9 gap-2"></div>
            </div>
             <div id="quiz-container" class="bg-purple-50 p-6 rounded-xl shadow-md hidden w-full">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl md:text-3xl font-bold text-purple-700">Thử Tài Của Bé</h2>
                    <div id="score" class="text-2xl md:text-3xl text-indigo-800 font-bold bg-white px-4 py-2 rounded-lg shadow-inner">Điểm: 0/0</div>
                </div>
                <div id="quiz-content">
                    <div class="md:grid md:grid-cols-2 md:gap-8 md:items-center">
                        <div class="text-center">
                             <div class="bg-white p-4 rounded-lg shadow-inner mb-4">
                                <p id="question" class="text-4xl font-bold text-gray-800 h-12 flex items-center justify-center">?</p>
                            </div>
                            <div id="answer-box" class="bg-white p-3 rounded-lg shadow-inner mb-4 border-2 border-purple-200 min-h-[56px] flex items-center justify-center">
                                <p id="selected-answer-display" class="text-3xl font-bold text-gray-800 tracking-widest">&nbsp;</p>
                            </div>
                        </div>
                        <div id="number-pad" class="grid grid-cols-3 gap-2 mb-4"></div>
                    </div>
                    <div class="text-center">
                        <div id="feedback" class="mt-3 h-8 text-2xl font-bold"></div>
                        <div class="mt-4">
                            <button id="check-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105" disabled>Kiểm Tra</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Snake Game Screen -->
        <div id="snake-game-screen" class="screen !justify-start h-full">
            <div id="canvas-container" class="relative w-full flex-grow bg-gray-800">
                <canvas id="snake-canvas"></canvas>
                <button class="back-btn absolute top-2 left-2 z-20 p-2 rounded-full bg-black/30 text-white hover:bg-black/50 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div id="game-over-screen" class="absolute inset-0 bg-black/70 text-white text-center flex-col justify-center items-center rounded-lg hidden">
                    <h3 class="text-5xl font-extrabold">Thua Rồi!</h3>
                    <p class="text-2xl mt-2">Điểm của bạn: <span id="final-score">0</span></p>
                    <button id="restart-snake-btn" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl">Chơi Lại</button>
                </div>
            </div>
            <div id="snake-controls" class="w-full p-2 bg-white/50 backdrop-blur-sm flex justify-center items-center gap-2">
                <div id="snake-input-pad" class="grid grid-cols-5 gap-2">
                    <!-- JS will populate 0-9 -->
                </div>
                <div class="flex flex-col gap-2">
                    <div id="snake-answer-display-container" class="bg-white/80 rounded-lg text-3xl font-bold text-gray-800 h-14 flex items-center justify-center shadow-inner">
                        <span id="snake-answer-display"></span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="snake-clear-btn" class="snake-control-btn w-14 h-14 bg-red-500 text-white rounded-lg flex items-center justify-center shadow-md active:bg-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                 <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                         <button id="snake-submit-btn" class="snake-control-btn w-14 h-14 bg-green-500 text-white rounded-lg flex items-center justify-center shadow-md active:bg-green-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SHARED DOM ELEMENTS & FUNCTIONS ---
        const mainContainer = document.getElementById('main-container');
        const screens = document.querySelectorAll('.screen');
        const backBtns = document.querySelectorAll('.back-btn');

        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            const screenToShow = document.getElementById(screenId);
            screenToShow.classList.add('active');

            if (screenId === 'snake-game-screen') {
                document.body.style.overflow = 'hidden';
                mainContainer.classList.remove('max-w-lg', 'md:max-w-4xl', 'p-4', 'md:p-6', 'rounded-2xl');
                mainContainer.classList.add('w-screen', 'h-screen', 'p-0', 'rounded-none', 'max-w-none');
            } else {
                document.body.style.overflow = '';
                mainContainer.classList.add('max-w-lg', 'md:max-w-4xl', 'p-4', 'md:p-6', 'rounded-2xl');
                mainContainer.classList.remove('w-screen', 'h-screen', 'p-0', 'rounded-none', 'max-w-none');
            }

            if (screenId === 'home-screen') {
                resetAllGames();
            }
        }
        
        function resetAllGames() {
            resetQuizState();
            if (typeof stopSnakeGame === 'function') {
               stopSnakeGame();
            }
        }
        
        backBtns.forEach(btn => btn.addEventListener('click', () => showScreen('home-screen')));

        // --- MULTIPLICATION QUIZ LOGIC (Unchanged) ---
        const goToLearnBtn = document.getElementById('go-to-learn');
        const goToQuizBtn = document.getElementById('go-to-quiz');
        const learnTableSelection = document.getElementById('learn-table-selection');
        const quizTableSelection = document.getElementById('quiz-table-selection');
        const quizSetup = document.getElementById('quiz-setup');
        const tableDisplayContainer = document.getElementById('table-display-container');
        const tableNumberDisplay = document.getElementById('table-number-display');
        const tableContent = document.getElementById('table-content');
        const quizContainer = document.getElementById('quiz-container');
        const questionEl = document.getElementById('question');
        const answerBox = document.getElementById('answer-box');
        const selectedAnswerDisplay = document.getElementById('selected-answer-display');
        const numberPad = document.getElementById('number-pad');
        const checkBtn = document.getElementById('check-btn');
        const feedbackEl = document.getElementById('feedback');
        const scoreEl = document.getElementById('score');
        let quizCurrentTable = null, quizCurrentNum1 = null, quizCurrentNum2 = null, quizScore = 0, quizTotalQuestions = 0, quizSelectedAnswerString = '', isWaitingForNextQuizQuestion = false;
        function resetQuizState() { quizCurrentTable = null; document.querySelectorAll('#learn-table-selection .table-button, #quiz-table-selection .table-button').forEach(btn => btn.classList.remove('active')); tableDisplayContainer.classList.add('hidden'); quizContainer.classList.add('hidden'); quizSetup.style.display = 'block'; }
        function createTableSelection(container, onSelectCallback, isQuizMode = false) { container.innerHTML = ''; const endRange = isQuizMode ? 9 : 10; for (let i = 2; i <= endRange; i++) { const button = document.createElement('button'); button.textContent = `${i}`; button.dataset.table = i; button.className = 'table-button text-base sm:text-lg font-bold py-2 sm:py-3 px-2 rounded-lg bg-white shadow-md hover:bg-indigo-200 transition-all duration-300 border-2 border-indigo-200'; button.addEventListener('click', () => { container.querySelectorAll('.table-button').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); onSelectCallback(i); }); container.appendChild(button); } if (isQuizMode) { const button = document.createElement('button'); button.textContent = `Ngẫu nhiên`; button.dataset.table = 'random'; button.className = 'table-button text-base sm:text-lg font-bold py-2 sm:py-3 px-2 rounded-lg bg-white shadow-md hover:bg-purple-200 transition-all duration-300 border-2 border-purple-300 bg-purple-100'; button.addEventListener('click', () => { container.querySelectorAll('.table-button').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); onSelectCallback('random'); }); container.appendChild(button); } }
        function selectForLearn(tableNum) { quizCurrentTable = tableNum; displayTable(tableNum); }
        function selectForQuiz(tableNum) { quizCurrentTable = tableNum; quizSetup.style.display = 'none'; quizContainer.classList.remove('hidden'); startQuiz(); }
        function createNumberPad(container, onNumber, onClear) { container.innerHTML = ''; const buttons = ['1', '2', '3', '4', '5', '6', '7', '8', '9', 'Xóa', '0']; buttons.forEach(val => { const button = document.createElement('button'); button.textContent = val; button.className = 'number-pad-btn text-xl sm:text-2xl font-bold py-3 rounded-lg bg-white shadow-md hover:bg-purple-200 transition-all duration-300 border-2 border-purple-200 focus:ring-2 focus:ring-purple-400'; if (val === 'Xóa') { button.classList.add('bg-pink-100', 'hover:bg-pink-200', 'border-pink-300', 'col-span-2'); button.addEventListener('click', onClear); } else { button.addEventListener('click', () => onNumber(val)); } container.appendChild(button); }); }
        function handleQuizNumberClick(digit) { if (quizSelectedAnswerString.length < 3 && !isWaitingForNextQuizQuestion) { quizSelectedAnswerString += digit; updateQuizAnswerDisplay(); } }
        function handleQuizClearClick() { quizSelectedAnswerString = ''; updateQuizAnswerDisplay(); }
        function updateQuizAnswerDisplay() { selectedAnswerDisplay.innerHTML = quizSelectedAnswerString === '' ? '&nbsp;' : quizSelectedAnswerString; checkBtn.disabled = quizSelectedAnswerString === ''; }
        function toggleQuizNumberPad(enabled) { numberPad.querySelectorAll('.number-pad-btn').forEach(btn => btn.disabled = !enabled); }
        function displayTable(tableNum) { tableDisplayContainer.classList.remove('hidden'); tableNumberDisplay.textContent = tableNum; tableContent.innerHTML = ''; for (let i = 1; i <= 10; i++) { const p = document.createElement('p'); p.textContent = `${tableNum} x ${i} = ${tableNum * i}`; p.className = "py-1 px-2 rounded hover:bg-indigo-200 transition-colors"; tableContent.appendChild(p); } }
        function startQuiz() { quizScore = 0; quizTotalQuestions = 0; updateQuizScore(); generateQuizQuestion(); }
        function generateQuizQuestion() { if (quizCurrentTable === 'random') { quizCurrentNum1 = Math.floor(Math.random() * 9) + 2; } else { quizCurrentNum1 = quizCurrentTable; } quizCurrentNum2 = Math.floor(Math.random() * 10) + 1; questionEl.textContent = `${quizCurrentNum1} x ${quizCurrentNum2} = ?`; handleQuizClearClick(); feedbackEl.textContent = ''; feedbackEl.className = 'mt-3 h-8 text-2xl font-bold'; toggleQuizNumberPad(true); isWaitingForNextQuizQuestion = false; }
        function checkQuizAnswer() { if (quizSelectedAnswerString === '' || isWaitingForNextQuizQuestion) return; const userAnswer = parseInt(quizSelectedAnswerString); const correctAnswer = quizCurrentNum1 * quizCurrentNum2; quizTotalQuestions++; toggleQuizNumberPad(false); if (userAnswer === correctAnswer) { isWaitingForNextQuizQuestion = true; quizScore++; feedbackEl.textContent = 'Chính xác! Hoan hô!'; feedbackEl.className = 'mt-3 h-8 text-2xl font-bold text-green-600 feedback-correct'; answerBox.classList.add('flash-green'); checkBtn.disabled = true; setTimeout(() => { answerBox.classList.remove('flash-green'); generateQuizQuestion(); }, 1500); } else { feedbackEl.textContent = `Sai rồi! Thử lại nhé!`; feedbackEl.className = 'mt-3 h-8 text-2xl font-bold text-red-600 feedback-wrong'; answerBox.classList.add('flash-red'); setTimeout(() => { answerBox.classList.remove('flash-red'); handleQuizClearClick(); toggleQuizNumberPad(true); }, 800); } updateQuizScore(); }
        function updateQuizScore() { scoreEl.textContent = `Điểm: ${quizScore}/${quizTotalQuestions}`; }
        function initQuiz() { goToLearnBtn.addEventListener('click', () => showScreen('learn-screen')); goToQuizBtn.addEventListener('click', () => showScreen('quiz-screen')); createTableSelection(learnTableSelection, selectForLearn); createTableSelection(quizTableSelection, selectForQuiz, true); createNumberPad(numberPad, handleQuizNumberClick, handleQuizClearClick); checkBtn.addEventListener('click', checkQuizAnswer); }
        initQuiz();

        // --- NEW SNAKE GAME LOGIC ---
        const goToSnakeBtn = document.getElementById('go-to-snake');
        const canvas = document.getElementById('snake-canvas');
        const ctx = canvas.getContext('2d');
        const canvasContainer = document.getElementById('canvas-container');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreEl = document.getElementById('final-score');
        const restartSnakeBtn = document.getElementById('restart-snake-btn');
        
        // New controls
        const snakeInputPad = document.getElementById('snake-input-pad');
        const snakeSubmitBtn = document.getElementById('snake-submit-btn');
        const snakeClearBtn = document.getElementById('snake-clear-btn');
        const snakeAnswerDisplay = document.getElementById('snake-answer-display');
        let snakeInputString = '';

        let snake, food, snakeScore, cols, rows, cellSize;
        let path, currentPathIndex, snakeAnimationTimeout;
        let snakeGameOver = false;
        let isMoving = false;
        let animationFrameId;
        let isWarmupPhase = false;
        
        let foodTimer;
        const FOOD_BASE_LIFESPAN = 25000; // 25s for snake of length 1
        let flashState = true, lastFlashTime = 0;
        
        const levelThresholds = { 5: 1.2, 10: 1.4, 15: 1.6 }; // Grid size multipliers

        function resizeCanvas() {
            const containerWidth = canvasContainer.clientWidth;
            const containerHeight = canvasContainer.clientHeight;
            
            if (containerWidth === 0 || containerHeight === 0) return;

            const isPortrait = containerHeight > containerWidth;

            let baseCols = isPortrait ? 9 : 16;
            let baseRows = isPortrait ? 16 : 9;
            
            let multiplier = 1;
            for(const score in levelThresholds){
                if(snakeScore >= score) multiplier = levelThresholds[score];
            }
            
            cols = Math.floor(baseCols * multiplier);
            rows = Math.floor(baseRows * multiplier);

            const aspectRatio = cols / rows;
            
            canvas.width = containerWidth;
            canvas.height = containerWidth / aspectRatio;

            if (canvas.height > containerHeight) {
                canvas.height = containerHeight;
                canvas.width = canvas.height * aspectRatio;
            }
            
            canvas.style.width = `${canvas.width}px`;
            canvas.style.height = `${canvas.height}px`;
            canvas.style.position = 'absolute';
            canvas.style.left = `${(containerWidth - canvas.width) / 2}px`;
            canvas.style.top = `${(containerHeight - canvas.height) / 2}px`;

            cellSize = canvas.width / cols;
        }

        function startSnakeGame() {
            gameOverScreen.style.display = 'none';
            snakeGameOver = false;
            snakeScore = 0;
            path = null;
            isWarmupPhase = true; 

            resizeCanvas(); 

            snake = [{ x: Math.floor(cols / 2), y: Math.floor(rows / 2) }];
            
            handleClearInput();
            
            const foodX = Math.min(cols - 1, snake[0].x + 2);
            const foodY = snake[0].y;
            food = { x: foodX, y: foodY, isWarmup: true };
            
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();

            isMoving = true; 
            path = findShortestPath(snake[0], food);
            currentPathIndex = 0;
            setTimeout(moveSnake, 500); 
        }
        
        function stopSnakeGame() {
            snakeGameOver = true;
            clearTimeout(foodTimer);
            clearTimeout(snakeAnimationTimeout);
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        function gameLoop() {
            if (snakeGameOver) return;
            drawGame();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Draw snake
            snake.forEach((part, index) => {
                ctx.fillStyle = index === 0 ? '#16a34a' : '#4ade80';
                ctx.fillRect(part.x * cellSize, part.y * cellSize, cellSize, cellSize);
                ctx.strokeStyle = '#f0fdf4';
                ctx.strokeRect(part.x * cellSize, part.y * cellSize, cellSize, cellSize);
            });
            
            // Draw food
            if (food) {
                let opacity = 1;
                let drawText = !food.isWarmup;
                
                if (!isMoving && !food.isWarmup) {
                    const elapsed = Date.now() - food.createdAt;
                    opacity = Math.max(0.2, 1 - (elapsed / food.lifespan));

                    const now = Date.now();
                    if (now - lastFlashTime > 150) {
                        flashState = !flashState;
                        lastFlashTime = now;
                    }
                } else {
                    flashState = true;
                }

                if (flashState) {
                    ctx.fillStyle = `rgba(249, 115, 22, ${opacity})`;
                    ctx.fillRect(food.x * cellSize, food.y * cellSize, cellSize, cellSize);

                    if (drawText) {
                        const text = `${food.num1} x ${food.num2}`;
                        const fontSize = Math.max(14, cellSize * 0.45);
                        ctx.font = `bold ${fontSize}px 'Baloo 2'`;
                        ctx.fillStyle = 'black';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(text, food.x * cellSize + cellSize / 2, food.y * cellSize + cellSize / 2);
                    }
                }
            }
        }
        
        function isPositionOnSnake(x, y, ignoreHead = false) {
            const snakeParts = ignoreHead ? snake.slice(1) : snake;
            return snakeParts.some(part => part.x === x && part.y === y);
        }

        function generateFood() {
            clearTimeout(foodTimer);
            let foodX, foodY;
            do {
                foodX = Math.floor(Math.random() * cols);
                foodY = Math.floor(Math.random() * rows);
            } while (isPositionOnSnake(foodX, foodY));
            
            const num1 = Math.floor(Math.random() * 9) + 2;
            const num2 = Math.floor(Math.random() * 10) + 1;
            const lifespan = Math.max(8000, FOOD_BASE_LIFESPAN - (snake.length * 250));
            
            food = { x: foodX, y: foodY, num1, num2, answer: num1 * num2, createdAt: Date.now(), lifespan, isWarmup: false };
            
            foodTimer = setTimeout(handleFoodTimeout, lifespan);
            handleClearInput();
        }

        function handleFoodTimeout() {
            snake.pop();
            if (snake.length < 1) {
                gameOver();
            } else {
                generateFood();
            }
        }
        
        function updateAnswerDisplay() {
            snakeAnswerDisplay.textContent = snakeInputString || '';
        }

        function handleNumberInput(digit) {
            if (snakeInputString.length < 3) {
                snakeInputString += digit;
                updateAnswerDisplay();
            }
        }

        function handleClearInput() {
            snakeInputString = '';
            updateAnswerDisplay();
        }

        function createSnakeInputControls() {
            snakeInputPad.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const digit = i % 10;
                const btn = document.createElement('button');
                btn.textContent = digit;
                btn.className = 'snake-control-btn w-14 h-14 bg-white/80 text-2xl font-bold text-gray-800 rounded-lg shadow-md active:bg-gray-200';
                btn.addEventListener('click', () => handleNumberInput(digit));
                snakeInputPad.appendChild(btn);
            }
        }
        
        function countReachableCells(start) {
            const queue = [start];
            const visited = new Set([`${start.x},${start.y}`]);
            let count = 0;
            while(queue.length > 0) {
                const pos = queue.shift();
                count++;
                const directions = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                for (const [dx, dy] of directions) {
                    const nextX = pos.x + dx, nextY = pos.y + dy;
                    if (nextX >= 0 && nextX < cols && nextY >= 0 && nextY < rows && !visited.has(`${nextX},${nextY}`) && !isPositionOnSnake(nextX, nextY, false)) {
                        visited.add(`${nextX},${nextY}`);
                        queue.push({x: nextX, y: nextY});
                    }
                }
            }
            return count;
        }

        function checkSnakeAnswer() {
            if (isMoving || isWarmupPhase || snakeInputString === '') return;
            const userAnswer = parseInt(snakeInputString);
            
            if (userAnswer === food.answer) {
                clearTimeout(foodTimer);
                path = findShortestPath(snake[0], food);
                
                if (path && isPathSafe(path)) {
                    isMoving = true;
                    currentPathIndex = 0;
                    moveSnake();
                } else {
                    // No valid path found, check why
                    const reachableCells = countReachableCells(snake[0]);
                    
                    // If snake is in a cramped space (by "wall")
                    if (snake.length > 5 && reachableCells < snake.length * 2) {
                        snake.unshift({x: food.x, y: food.y}); 
                        snakeScore++;
                        resizeCanvas(); // Expand the grid
                        generateFood();
                    } else {
                        // Snake has trapped the food in a loop, wait for timeout
                        const elapsed = Date.now() - food.createdAt;
                        const remainingTime = Math.max(0, food.lifespan - elapsed);
                        foodTimer = setTimeout(handleFoodTimeout, remainingTime);
                    }
                }
            } else { 
                snake.pop();
                if (snake.length < 1) gameOver();
            }
        }
        
        function isPathSafe(pathToFollow) {
            const tempSnake = snake.map(p => ({...p}));
            for (let i = 0; i < pathToFollow.length; i++) {
                const nextHeadPos = pathToFollow[i];
                const body = tempSnake.slice(0, tempSnake.length - 1); 
                if (body.some(part => part.x === nextHeadPos.x && part.y === nextHeadPos.y)) {
                    return false;
                }
                tempSnake.unshift({ ...nextHeadPos });
                if (i < pathToFollow.length - 1) tempSnake.pop();
            }
            return true;
        }

        function moveSnake() {
            if (!path || currentPathIndex >= path.length) {
                if (isWarmupPhase) {
                    isWarmupPhase = false;
                    isMoving = false;
                    generateFood(); 
                } else {
                    isMoving = false;
                    snakeScore++;
                    resizeCanvas();
                    generateFood();
                }
                return;
            }
            const nextStep = path[currentPathIndex];
            snake.unshift({ x: nextStep.x, y: nextStep.y });
            if (currentPathIndex < path.length - 1 || isWarmupPhase) {
                snake.pop();
            }
            currentPathIndex++;
            snakeAnimationTimeout = setTimeout(moveSnake, 80);
        }

        function findShortestPath(start, end) {
            const queue = [[start]];
            const visited = new Set([`${start.x},${start.y}`]);
            while (queue.length > 0) {
                const path = queue.shift();
                const pos = path[path.length - 1];
                if (pos.x === end.x && pos.y === end.y) return path.slice(1);
                const directions = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                for (const [dx, dy] of directions) {
                    const nextX = pos.x + dx, nextY = pos.y + dy;
                    if (nextX >= 0 && nextX < cols && nextY >= 0 && nextY < rows && !visited.has(`${nextX},${nextY}`) && !isPositionOnSnake(nextX, nextY, true)) {
                        visited.add(`${nextX},${nextY}`);
                        queue.push([...path, {x: nextX, y: nextY}]);
                    }
                }
            }
            return null;
        }
        
        function gameOver() {
            stopSnakeGame();
            finalScoreEl.textContent = snakeScore;
            gameOverScreen.style.display = 'flex';
        }

        function initSnakeGame() {
            goToSnakeBtn.addEventListener('click', () => {
                showScreen('snake-game-screen');
                requestAnimationFrame(startSnakeGame);
            });
            createSnakeInputControls();
            snakeSubmitBtn.addEventListener('click', checkSnakeAnswer);
            snakeClearBtn.addEventListener('click', handleClearInput);
            restartSnakeBtn.addEventListener('click', startSnakeGame);
            window.addEventListener('resize', resizeCanvas);
        }
        initSnakeGame();
    </script>
</body>
</html>

